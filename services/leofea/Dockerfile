FROM python:3.12.1

# Change user
USER root

# Upgrade packages
RUN apt-get update
RUN apt-get upgrade -y

# Install python packages
RUN pip install flask
RUN pip install requests-toolbelt

# Make directories
RUN mkdir /app
RUN mkdir /app/sdk
RUN mkdir /app/sdk/src
RUN mkdir /out

# Install SDK dependencies
WORKDIR /app/sdk
COPY --from=sdk pyproject.toml /app/sdk
RUN pip install -e .

# Install APP + SDK sources
COPY src /app
COPY --from=sdk src/caddrive /app/sdk/src

# Run APP
EXPOSE 5000/tcp
WORKDIR /app
ENTRYPOINT python
CMD -u src/main.py